### LDAP JAM ###
### Setup for new version Linux in O2 Production
### Script Creater for Raphael Maria
### Date 14/03/2019 version build 1.0

echo "Iniciando Backup das configurações atuais"
mv /etc/nslcd.conf /etc/nslcd.conf.bkp

echo "# The user and group nslcd should run as.
uid nslcd
gid ldap

# Note: %2f encodes the '/' used as directory separator
uri ldap://192.168.8.9

# The distinguished name of the search base.
base dc=o2pos,dc=com

# This comment prevents repeated auto-migration of settings.
ssl no
tls_cacertdir /etc/openldap/cacerts" >> /etc/nslcd.conf

mv /etc/openldap/ldap.conf /etc/openldap/ldap.conf.bkp

echo "#
# LDAP Defaults

#

# See ldap.conf(5) for details

# This file should be world readable but not world writable.
#BASE   dc=example,dc=com
#URI    ldap://ldap.example.com ldap://ldap-master.example.com:666

#SIZELIMIT      12
#TIMELIMIT      15
#DEREF          never

TLS_CACERTDIR /etc/openldap/cacerts

# Turning this off breaks GSSAPI used with krb5 when rdns = false
SASL_NOCANON    on
BASE dc=o2pos,dc=com
URI ldap://192.168.8.9" >> /etc/openldap/ldap.conf

mv /etc/nsswitch.conf /etc/nsswitch.conf.bkp
echo "# /etc/nsswitch.conf 

#

# An example Name Service Switch config file. This file should be

# sorted with the most-used services at the beginning.

#

# The entry '[NOTFOUND=return]' means that the search for an

# entry should stop if the search in the previous entry turned

# up nothing. Note that if the search failed due to some other reason

# (like no NIS server responding) then the search continues with the

# next entry.

#

# Valid entries include:

#

#       nisplus                 Use NIS+ (NIS version 3)

#       nis                     Use NIS (NIS version 2), also called YP

#       dns                     Use DNS (Domain Name Service)

#       files                   Use the local files

#       db                      Use the local database (.db) files

#       compat                  Use NIS on compat mode

#       hesiod                  Use Hesiod for user lookups

#       [NOTFOUND=return]       Stop searching if not found so far

#



# To use db, put the "db" in front of "files" for entries you want to be

# looked up first in the databases

#

# Example:

#passwd:    db files nisplus nis

#shadow:    db files nisplus nis

#group:     db files nisplus nis



passwd:     files sss ldap

shadow:     files sss ldap

group:      files sss ldap

#initgroups: files



#hosts:     db files nisplus nis dns

hosts:      files mdns4_minimal [NOTFOUND=return] dns myhostname



# Example - obey only what nisplus tells us...

#services:   nisplus [NOTFOUND=return] files

#networks:   nisplus [NOTFOUND=return] files

#protocols:  nisplus [NOTFOUND=return] files

#rpc:        nisplus [NOTFOUND=return] files

#ethers:     nisplus [NOTFOUND=return] files

#netmasks:   nisplus [NOTFOUND=return] files     



bootparams: nisplus [NOTFOUND=return] files



ethers:     files

netmasks:   files

networks:   files

protocols:  files

rpc:        files

services:   files sss



netgroup:   files sss ldap



publickey:  nisplus



automount:  files sss ldap

aliases:    files nisplus" >> /etc/nsswitch.conf


mv 

echo "#%PAM-1.0

## This file is auto-generated.

## User changes will be destroyed the next time authconfig is run.

auth        required      pam_env.so

auth        sufficient    pam_unix.so nullok try_first_pass

auth        requisite     pam_succeed_if.so uid >= 1000 quiet_success

auth        sufficient    pam_sss.so use_first_pass

auth        sufficient    pam_ldap.so use_first_pass

auth        required      pam_deny.so



account     required      pam_unix.so broken_shadow

account     sufficient    pam_localuser.so

account     sufficient    pam_succeed_if.so uid < 1000 quiet

account     [default=bad success=ok user_unknown=ignore] pam_sss.so

account     [default=bad success=ok user_unknown=ignore] pam_ldap.so

account     required      pam_permit.so



password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=

password    sufficient    pam_unix.so md5 shadow nullok try_first_pass use_authtok

password    sufficient    pam_sss.so use_authtok

password    sufficient    pam_ldap.so use_authtok

password    required      pam_deny.so



session     optional      pam_keyinit.so revoke

session     required      pam_limits.so

-session     optional      pam_systemd.so

session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid

session     required      pam_unix.so

session     optional      pam_sss.so

session     optional      pam_ldap.so" >> /etc/pam.d/password-auth-ac

mv /etc/pam.d/system-auth-ac /etc/pam.d/system-auth-ac.bkp

echo "#%PAM-1.0

# This file is auto-generated.

# User changes will be destroyed the next time authconfig is run.

auth        required      pam_env.so

auth        required      pam_faildelay.so delay=2000000

auth        [default=1 ignore=ignore success=ok] pam_succeed_if.so uid >= 1000 quiet

auth        [default=1 success=ok] pam_localuser.so

auth        sufficient    pam_unix.so nullok try_first_pass

auth        requisite     pam_succeed_if.so uid >= 1000 quiet_success

auth        sufficient    pam_sss.so forward_pass

auth        required      pam_deny.so



account     required      pam_unix.so broken_shadow

account     sufficient    pam_localuser.so

account     sufficient    pam_succeed_if.so uid < 1000 quiet

account     [default=bad success=ok user_unknown=ignore] pam_sss.so

account     [default=bad success=ok user_unknown=ignore] pam_ldap.so

account     required      pam_permit.so



password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=

password    sufficient    pam_unix.so md5 shadow nullok try_first_pass use_authtok

password    sufficient    pam_sss.so use_authtok

password    sufficient    pam_ldap.so use_authtok

password    required      pam_deny.so



session     optional      pam_keyinit.so revoke

session     required      pam_limits.so

-session     optional      pam_systemd.so

session     optional      pam_oddjob_mkhomedir.so umask=0077

session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid

session     required      pam_unix.so

session     optional      pam_ldap.so" >> /etc/pam.d/system-auth-ac

cat /etc/pam.d/system-auth-ac


